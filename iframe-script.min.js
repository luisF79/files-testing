function tristateHandler(e) {
  const states = ['true', 'null', 'false']

  const i = states.indexOf(e.target.value) + 1
  e.target.value = i < states.length ? states[i] : states[0]
  switch (e.target.value) {
    case states[0]:
      e.target.indeterminate = false
      e.target.checked = true
      break
    case states[1]:
      e.target.checked = false
      e.target.indeterminate = true
      break
    default:
      e.target.indeterminate = false
      e.target.checked = false
  }
}

document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.onclick = tristateHandler)

document.querySelectorAll('.eq-icon').forEach(img => {
  img.onclick = (e) => {
    e.target.classList.toggle('disabled-icon')
  }
})

const extractData = () => {
  const imgs = document.querySelectorAll('td.eq-icon')
  const inputs = document.querySelectorAll('input[type="text"]')
  const checkbox = document.querySelectorAll('input[type="checkbox"]')
  const dates = document.querySelectorAll('input[type="date"]')
  const times = document.querySelectorAll('input[type="time"]')
  const textareas = document.querySelectorAll('textarea')
  const selects = document.querySelectorAll('select')

  const data = {}

  for (const img of imgs) {
    data[img.id] = !document.getElementById(img.id).classList.contains('disabled-icon')
  }

  for (const input of inputs) {
    data[input.id] = input.value
  }

  for (const cb of checkbox) {
    if (cb.indeterminate) {
      data[cb.id] = null
    } else {
      data[cb.id] = cb.checked
    }
  }

  for (const date of dates) {
    data[date.id] = date.value
  }

  for (const time of times) {
    data[time.id] = time.value
  }

  for (const ta of textareas) {
    data[ta.id] = ta.value
  }

  for (const select of selects) {
    data[select.id] = select.value
  }

  return data
}

const cleanData = () => {
  const imgs = document.querySelectorAll('td.eq-icon')
  const inputs = document.querySelectorAll('input[type="text"]')
  const checkbox = document.querySelectorAll('input[type="checkbox"]')
  const dates = document.querySelectorAll('input[type="date"]')
  const times = document.querySelectorAll('input[type="time"]')
  const textareas = document.querySelectorAll('textarea')
  const selects = document.querySelectorAll('select')

  for (const img of imgs) {
    document.getElementById(img.id).classList.remove('disabled-icon')
  }

  for (const input of inputs) {
    input.value = ''
  }

  for (const cb of checkbox) {
    cb.checked = false
    cb.indeterminate = false
  }

  for (const date of dates) {
    date.value = ''
  }

  for (const time of times) {
    time.value = ''
  }

  for (const textarea of textareas) {
    textarea.value = ''
  }

  for (const select of selects) {
    select.value = 0
  }
}

const disableDocInteractivity = () => {
  const disableScreen = document.getElementById('disableScreen')
  if (disableScreen) {
    disableScreen.style.display = 'block'
    return
  }

  const screen = document.createElement('div')
  const bodyHeigth = document.body.scrollHeight + 'px'
  screen.id = 'disableScreen'
  screen.style.width = '100%'
  screen.style.height = bodyHeigth
  screen.style.position = 'absolute'
  screen.style.top = '0'
  screen.style.left = '0'

  document.body.appendChild(screen)
}

const enableDocInteractivity = () => {
  const screen = document.getElementById('disableScreen')
  if (screen) {
    screen.style.display = 'none'
  }
}

const setData = (data) => {
  cleanData()
  for (const key in data) {
    if (key.includes('cb')) {
      if (data[key] === null) {
        document.getElementById(key).indeterminate = true
      } else {
        document.getElementById(key).checked = data[key]
      }
    } else if (key.includes('img')) {
      if (data[key] === false) {
        document.getElementById(key).classList.add('disabled-icon')
      } else if (data[key] === true) {
        document.getElementById(key).classList.remove('disabled-icon')
      }
    } else {
      document.getElementById(key).value = data[key]
    }
  }
}

let zoomIndex = 9
// Indexes           0    1     2   3    4    5    6    7    8   9   10   11  12    13   14   15   16   17   18
const zoomValues = [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9]

const zoomIn = () => {
  if (zoomIndex === 18) return
  zoomIndex += 1
  document.body.style.transform = `scale(${zoomValues[zoomIndex]})`
  document.body.style.transformOrigin = '0 0'
}

const zoomOut = () => {
  if (zoomIndex === 0) return
  zoomIndex -= 1
  document.body.style.transform = `scale(${zoomValues[zoomIndex]})`
  document.body.style.transformOrigin = '0 0'
}

window.addEventListener('message', (event) => {
  if (event.data.sender !== 'SoftOil') return

  if (event.data.type === 'print') {
    return window.print()
  }

  if (event.data.type === 'set-data') {
    const fields = JSON.parse(event.data.fields)
    setData(fields)
  }

  if (event.data.type === 'extract-data') {
    const obj = {
      fields: extractData(),
      sender: 'SoftOil'
    }
    window.parent.postMessage(obj, window.origin)
  }

  if (event.data.type === 'disable-doc') {
    disableDocInteractivity()
  }

  if (event.data.type === 'enable-doc') {
    enableDocInteractivity()
  }

  if (event.data.type === 'zoom-in') {
    zoomIn()
  }

  if (event.data.type === 'zoom-out') {
    zoomOut()
  }
})