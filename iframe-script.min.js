let isConvertioFile = document.body.scrollHeight === 0

// event listener to avoid errors if defer attribute is missing in scrip tag
addEventListener("DOMContentLoaded", (event) => {
  isConvertioFile = document.body.scrollHeight === 0
})

function tristateHandler(e) {
  const states = ['true', 'null', 'false']

  const i = states.indexOf(e.target.value) + 1
  e.target.value = i < states.length ? states[i] : states[0]
  switch (e.target.value) {
    case states[0]:
      e.target.indeterminate = false
      e.target.checked = true
      break
    case states[1]:
      e.target.checked = false
      e.target.indeterminate = true
      break
    default:
      e.target.indeterminate = false
      e.target.checked = false
  }
}

document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.onclick = tristateHandler)

document.querySelectorAll('.eq-icon').forEach(img => {
  img.onclick = (e) => {
    e.target.classList.toggle('disabled-icon')
  }
})

const extractData = () => {
  const imgs = document.querySelectorAll('td.eq-icon')
  const inputs = document.querySelectorAll('input[type="text"]')
  const checkbox = document.querySelectorAll('input[type="checkbox"]')
  const dates = document.querySelectorAll('input[type="date"]')
  const times = document.querySelectorAll('input[type="time"]')
  const textareas = document.querySelectorAll('textarea')
  const selects = document.querySelectorAll('select')

  const data = {}

  for (const img of imgs) {
    data[img.id] = !document.getElementById(img.id).classList.contains('disabled-icon')
  }

  for (const input of inputs) {
    if (input.id) {
      data[input.id] = input.value
    }
  }

  for (const cb of checkbox) {
    if (cb.indeterminate) {
      data[cb.id] = null
    } else {
      data[cb.id] = cb.checked
    }
  }

  for (const date of dates) {
    data[date.id] = date.value
  }

  for (const time of times) {
    data[time.id] = time.value
  }

  for (const ta of textareas) {
    data[ta.id] = ta.value
  }

  for (const select of selects) {
    data[select.id] = select.value
  }

  return data
}

const cleanData = () => {
  const imgs = document.querySelectorAll('td.eq-icon')
  const inputs = document.querySelectorAll('input[type="text"]')
  const checkbox = document.querySelectorAll('input[type="checkbox"]')
  const dates = document.querySelectorAll('input[type="date"]')
  const times = document.querySelectorAll('input[type="time"]')
  const textareas = document.querySelectorAll('textarea')
  const selects = document.querySelectorAll('select')

  for (const img of imgs) {
    document.getElementById(img.id).classList.remove('disabled-icon')
  }

  for (const input of inputs) {
    if (input.id) {
      input.value = ''
    }
  }

  for (const cb of checkbox) {
    cb.checked = false
    cb.indeterminate = false
  }

  for (const date of dates) {
    date.value = ''
  }

  for (const time of times) {
    time.value = ''
  }

  for (const textarea of textareas) {
    textarea.value = ''
  }

  for (const select of selects) {
    select.value = 0
  }
}

const disableDocInteractivity = () => {
  const disableScreen = document.getElementById('disable-screen')
  if (disableScreen) {
    disableScreen.style.display = 'block'
    return
  }

  const bodyHeigth = document.body.scrollHeight

  const screen = document.createElement('div')

  if (!isConvertioFile) {
    screen.style.height = `${bodyHeigth}px`
    document.body.appendChild(screen)
  } else {
    const pageContainer = document.getElementById('page-container')
    screen.style.height = `${pageContainer.scrollHeight}px`
    pageContainer.appendChild(screen)
  }

  screen.id = 'disable-screen'
  screen.style.width = '100%'
  screen.style.position = 'absolute'
  screen.style.top = '0'
  screen.style.left = '0'
  // screen.style.border = '2px solid red'
}

const enableDocInteractivity = () => {
  const screen = document.getElementById('disable-screen')
  if (screen) {
    screen.style.display = 'none'
  }
}

const setData = (data) => {
  cleanData()
  for (const key in data) {
    if (key.includes('cb')) {
      if (data[key] === null) {
        document.getElementById(key).indeterminate = true
      } else {
        document.getElementById(key).checked = data[key]
      }
    } else if (key.includes('img')) {
      if (data[key] === false) {
        document.getElementById(key).classList.add('disabled-icon')
      } else if (data[key] === true) {
        document.getElementById(key).classList.remove('disabled-icon')
      }
    } else {
      document.getElementById(key).value = data[key]
    }
  }
}

let zoomIndex = isConvertioFile ? 0 : 9
// Indexes           
const zoomValues = isConvertioFile
  // 0   1    2    3    4    5    6    7     8   9
  ? [1, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9]
  //  0    1     2   3    4    5    6    7    8   9   10   11  12    13   14   15   16   17   18
  : [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9]

const zoomIn = () => {
  if (isConvertioFile && zoomIndex === 9) return
  if (!isConvertioFile && zoomIndex === 18) return
  zoomIndex += 1
  if (isConvertioFile) {
    const pageContainer = document.getElementById('page-container')
    pageContainer.style.transform = `scale(${zoomValues[zoomIndex]})`
    pageContainer.style.transformOrigin = '0 0'
    return
  }
  document.body.style.transform = `scale(${zoomValues[zoomIndex]})`
  document.body.style.transformOrigin = '0 0'
}

const zoomOut = () => {
  if (zoomIndex === 0) return
  zoomIndex -= 1
  if (isConvertioFile) {
    const pageContainer = document.getElementById('page-container')
    pageContainer.style.transform = `scale(${zoomValues[zoomIndex]})`
    pageContainer.style.transformOrigin = '0 0'
    return
  }
  document.body.style.transform = `scale(${zoomValues[zoomIndex]})`
  document.body.style.transformOrigin = '0 0'
}

const setDocumentInfo = (docInfo) => {
  const stationNameInputs = document.getElementsByClassName('station-name')
  const addressInputs = document.getElementsByClassName('station-address')
  const stationPermitInputs = document.getElementsByClassName('station-permit')
  const stationLogo = document.getElementsByClassName('station-logo')

  for (input of stationNameInputs) {
    input.value = docInfo?.stationName
  }

  for (input of addressInputs) {
    input.value = docInfo?.stationAddress
  }

  for (input of stationPermitInputs) {
    input.value = docInfo?.stationPermit
  }

  for (logo of stationLogo) {
    logo.setAttribute('src', docInfo?.stationLogo)
  }
}

const eventTypes = {
  PRINT: 'print',
  SET_DATA: 'set-data',
  EXTRACT_DATA: 'extract-data',
  DISABLE_DOC: 'disable-doc',
  ENABLE_DOC: 'enable-doc',
  ZOOM_IN: 'zoom-in',
  ZOOM_OUT: 'zoom-out',
  SET_DOC_INFO: 'set-doc-info'
}

window.addEventListener('message', (event) => {
  if (event.data.sender !== 'SoftOil') return

  if (event.data.type === eventTypes.PRINT) {
    return window.print()
  }

  if (event.data.type === eventTypes.SET_DATA) {
    const fields = JSON.parse(event.data.fields)
    setData(fields)
  }

  if (event.data.type === eventTypes.EXTRACT_DATA) {
    const obj = {
      fields: extractData(),
      sender: 'SoftOil'
    }
    window.parent.postMessage(obj, window.origin)
  }

  if (event.data.type === eventTypes.DISABLE_DOC) {
    disableDocInteractivity()
  }

  if (event.data.type === eventTypes.ENABLE_DOC) {
    enableDocInteractivity()
  }

  if (event.data.type === eventTypes.ZOOM_IN) {
    zoomIn()
  }

  if (event.data.type === eventTypes.ZOOM_OUT) {
    zoomOut()
  }

  if (event.data.type === eventTypes.SET_DOC_INFO) {
    setDocumentInfo(event.data.docInfo)
  }
})

disableDocInteractivity()