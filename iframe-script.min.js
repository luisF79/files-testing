// Add document interactivity after DOM load
addEventListener('DOMContentLoaded', () => {
  // flag to detect when file was converted from convertio
  let isConvertioFile = document.body.scrollHeight === 0

  const signs = document.querySelectorAll('img[class^=sign]')

  // remove src of signs to set data in a clear dom and add default styles
  for (const sign of signs) {
    sign.removeAttribute('src')
    sign.parentNode.style.display = 'flex'
    sign.parentNode.style.justifyContent = 'center'
    sign.style.cursor = 'pointer'
  }

  // handler for checkboxes with 3 states
  function tristateHandler(e) {
    const states = ['true', 'null', 'false']

    const i = states.indexOf(e.target.value) + 1
    e.target.value = i < states.length ? states[i] : states[0]
    switch (e.target.value) {
      case states[0]:
        e.target.indeterminate = false
        e.target.checked = true
        break
      case states[1]:
        e.target.checked = false
        e.target.indeterminate = true
        break
      default:
        e.target.indeterminate = false
        e.target.checked = false
    }
  }

  // add event listeners for checkboxes with 3 states
  document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.onclick = tristateHandler)

  // add listener for images that have an image which has disabled state
  document.querySelectorAll('.eq-icon').forEach(img => {
    img.onclick = e => {
      e.target.classList.toggle('disabled-icon')
    }
  })

  // function to add/remove signs
  const replaceSign = e => {
    const targetClass = e.target.classList[0]
    const targetSrc = e.target.src

    if (targetSrc) {
      if (confirm('Â¿Remover firma?')) {
        document.querySelectorAll(`.${targetClass}`).forEach(sign => {
          sign.removeAttribute('src')
          sign.style.background = '#00000030'
        })
      }
    } else {
      const message = {
        element: targetClass,
        sender: 'SoftOil',
        type: eventTypes.SIGN
      }
      window.parent.postMessage(message, window.origin)
    }
  }

  // add listener to all the images which class starts with "sign"
  document.querySelectorAll('img[class^=sign]').forEach(sign => {
    sign.onclick = replaceSign
  })

  // declare all document event types
  const eventTypes = {
    PRINT: 'print',
    SET_DATA: 'set-data',
    EXTRACT_DATA: 'extract-data',
    DISABLE_DOC: 'disable-doc',
    ENABLE_DOC: 'enable-doc',
    ZOOM_IN: 'zoom-in',
    ZOOM_OUT: 'zoom-out',
    SET_DOC_INFO: 'set-doc-info',
    SIGN: 'sign'
  }

  // function to remove background and alt attribute in images that don't have src value
  const hideEmptyImages = () => {
    const images = document.querySelectorAll('img')
    images.forEach(img => {
      img.setAttribute('alt', '')
      img.style.background = 'transparent'
    })
  }

  // function to show background and alt attribute in images that don't have src value
  // also to show area where user can click to add sign
  const showEmptyImages = () => {
    const images = document.querySelectorAll('img')
    images.forEach(img => {
      if (img.classList[0]?.includes('sign')) {
        img.setAttribute('alt', 'Click para firmar')
        if (!img.src) {
          img.style.background = '#00000030'
        }
      }
    })
  }

  // function to extract data from document fields
  const extractData = () => {
    const imgs = document.querySelectorAll('td.eq-icon')
    const inputs = document.querySelectorAll('input[type="text"]')
    const checkbox = document.querySelectorAll('input[type="checkbox"]')
    const dates = document.querySelectorAll('input[type="date"]')
    const times = document.querySelectorAll('input[type="time"]')
    const textareas = document.querySelectorAll('textarea')
    const selects = document.querySelectorAll('select')
    const signs = document.querySelectorAll('img[class^=sign]')

    const data = {}

    for (const sign of signs) {
      data[sign.classList[0]] = sign.src
    }

    for (const img of imgs) {
      data[img.id] = !document.getElementById(img.id).classList.contains('disabled-icon')
    }

    for (const input of inputs) {
      if (input.id) {
        data[input.id] = input.value
      }
    }

    for (const cb of checkbox) {
      if (cb.indeterminate) {
        data[cb.id] = null
      } else {
        data[cb.id] = cb.checked
      }
    }

    for (const date of dates) {
      data[date.id] = date.value
    }

    for (const time of times) {
      data[time.id] = time.value
    }

    for (const ta of textareas) {
      data[ta.id] = ta.value
    }

    for (const select of selects) {
      data[select.id] = select.value
    }

    return data
  }

  // clean data from all document fields
  const cleanData = () => {
    const imgs = document.querySelectorAll('td.eq-icon')
    const inputs = document.querySelectorAll('input[type="text"]')
    const checkbox = document.querySelectorAll('input[type="checkbox"]')
    const dates = document.querySelectorAll('input[type="date"]')
    const times = document.querySelectorAll('input[type="time"]')
    const textareas = document.querySelectorAll('textarea')
    const selects = document.querySelectorAll('select')
    const signs = document.querySelectorAll('img[class^=sign]')

    for (const sign of signs) {
      sign.removeAttribute('src')
      sign.style.background = '#00000030'
    }

    for (const img of imgs) {
      document.getElementById(img.id).classList.remove('disabled-icon')
    }

    for (const input of inputs) {
      if (input.id) {
        input.value = ''
      }
    }

    for (const cb of checkbox) {
      cb.checked = false
      cb.indeterminate = false
    }

    for (const date of dates) {
      date.value = ''
    }

    for (const time of times) {
      time.value = ''
    }

    for (const textarea of textareas) {
      textarea.value = ''
    }

    for (const select of selects) {
      select.value = 0
    }
  }

  // disables document interactivity
  const disableDocInteractivity = () => {
    const disableScreen = document.getElementById('disable-screen')
    if (disableScreen) {
      disableScreen.style.display = 'block'
      hideEmptyImages()
      return
    }

    const bodyHeigth = document.body.scrollHeight

    const screen = document.createElement('div')

    if (!isConvertioFile) {
      screen.style.height = `${bodyHeigth}px`
      document.body.appendChild(screen)
    } else {
      const pageContainer = document.getElementById('page-container')
      screen.style.height = `${pageContainer.scrollHeight}px`
      pageContainer.appendChild(screen)
    }

    screen.id = 'disable-screen'
    screen.style.width = '100%'
    screen.style.position = 'absolute'
    screen.style.top = '0'
    screen.style.left = '0'

    hideEmptyImages()
  }

  // enables document interactivity
  const enableDocInteractivity = () => {
    const screen = document.getElementById('disable-screen')
    if (screen) {
      screen.style.display = 'none'
    }
    showEmptyImages()
  }

  // prints the information in document fields to show stored data
  const setData = data => {
    cleanData()
    for (const key in data) {
      if (key.includes('cb')) {
        if (data[key] === null) {
          document.getElementById(key).indeterminate = true
        } else {
          document.getElementById(key).checked = data[key]
        }
      } else if (key.includes('img')) {
        if (data[key] === false) {
          document.getElementById(key).classList.add('disabled-icon')
        } else if (data[key] === true) {
          document.getElementById(key).classList.remove('disabled-icon')
        }
      } else if (key.includes('sign')) {
        const signs = document.querySelectorAll(`img[class=${key}]`)
        for (const sign of signs) {
          if (data[key]) {
            sign.setAttribute('src', data[key])
            sign.parentNode.style.display = 'flex'
            sign.parentNode.style.justifyContent = 'center'
            sign.style.background = 'transparent'
          }
        }
      } else {
        document.getElementById(key).value = data[key]
      }
    }
  }

  // if is convertio file, don't let document to do zoomOut
  let zoomIndex = isConvertioFile ? 0 : 9
  // Indexes
  const zoomValues = isConvertioFile
    // 0   1    2    3    4    5    6    7     8   9
    ? [1, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9]
    //  0    1     2   3    4    5    6    7    8   9   10   11  12    13   14   15   16   17   18
    : [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9]

  const zoomIn = () => {
    if (isConvertioFile && zoomIndex === 9) return
    if (!isConvertioFile && zoomIndex === 18) return
    zoomIndex += 1
    if (isConvertioFile) {
      const pageContainer = document.getElementById('page-container')
      pageContainer.style.transform = `scale(${zoomValues[zoomIndex]})`
      pageContainer.style.transformOrigin = '0 0'
      return
    }
    document.body.style.transform = `scale(${zoomValues[zoomIndex]})`
    document.body.style.transformOrigin = '0 0'
  }

  const zoomOut = () => {
    if (zoomIndex === 0) return
    zoomIndex -= 1
    if (isConvertioFile) {
      const pageContainer = document.getElementById('page-container')
      pageContainer.style.transform = `scale(${zoomValues[zoomIndex]})`
      pageContainer.style.transformOrigin = '0 0'
      return
    }
    document.body.style.transform = `scale(${zoomValues[zoomIndex]})`
    document.body.style.transformOrigin = '0 0'
  }

  // function to set the document headers info
  const setDocumentInfo = docInfo => {
    const stationNameInputs = document.getElementsByClassName('station-name')
    const addressInputs = document.getElementsByClassName('station-address')
    const stationPermitInputs = document.getElementsByClassName('station-permit')
    const stationLogo = document.getElementsByClassName('station-logo')

    for (const input of stationNameInputs) {
      input.value = docInfo?.stationName
    }

    for (const input of addressInputs) {
      input.value = docInfo?.stationAddress
    }

    for (const input of stationPermitInputs) {
      input.value = docInfo?.stationPermit
    }

    for (const logo of stationLogo) {
      logo.setAttribute('src', docInfo?.stationLogo)
    }
  }

  // function to sign doc, target refers to the element in which image will be placed (recommended to use class attr)
  // signImg is the url of the image
  const signDoc = ({ target, signImg }) => {
    const signs = document.getElementsByClassName(target)

    for (const sign of signs) {
      sign.setAttribute('src', signImg)
      sign.parentNode.style.display = 'flex'
      sign.parentNode.style.justifyContent = 'center'
      sign.style.background = 'transparent'
    }
  }

  // event listeners to watch when parent window (SGO app) posts a message to this scope
  // messages to this scope MUST have a property called "sender" with value "SoftOil"
  window.addEventListener('message', event => {
    if (event.data.sender !== 'SoftOil') return

    if (event.data.type === eventTypes.PRINT) {
      return window.print()
    }

    if (event.data.type === eventTypes.SET_DATA) {
      const fields = JSON.parse(event.data.fields)
      setData(fields)
      return
    }

    if (event.data.type === eventTypes.EXTRACT_DATA) {
      const obj = {
        fields: extractData(),
        sender: 'SoftOil',
        type: eventTypes.EXTRACT_DATA
      }
      window.parent.postMessage(obj, window.origin)
      return
    }

    if (event.data.type === eventTypes.DISABLE_DOC) {
      disableDocInteractivity()
      return
    }

    if (event.data.type === eventTypes.ENABLE_DOC) {
      enableDocInteractivity()
      return
    }

    if (event.data.type === eventTypes.ZOOM_IN) {
      zoomIn()
      return
    }

    if (event.data.type === eventTypes.ZOOM_OUT) {
      zoomOut()
      return
    }

    if (event.data.type === eventTypes.SET_DOC_INFO) {
      setDocumentInfo(event.data.docInfo)
      return
    }

    if (event.data.type === eventTypes.SIGN) {
      const target = event.data.element
      const signImg = event.data.signImg
      signDoc({ target, signImg })
      return
    }
  })

  // remove anchors href attribute to avoid redirection inside iframe container
  const removeAnchors = () => {
    document.querySelectorAll('a').forEach(a => {
      a.removeAttribute('href')
      a.removeAttribute('target')
    })
  }

  removeAnchors()

  // uncomment if empty images are not hidden when printing document
  // window.addEventListener("beforeprint", hideEmptyImages)

  // by default the document interactivity will be disabled
  disableDocInteractivity()
})
